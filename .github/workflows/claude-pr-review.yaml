name: Claude Docs Review
on:
  pull_request:
    types: [opened, ready_for_review]
    paths:
      - 'data/docs/**'
      - 'public/img/docs/**'
      - 'constants/docsSideNav.ts'
      - 'next.config.js'
      - 'scripts/check-doc-redirects.js'
      - 'scripts/check-docs-metadata.js'
  issue_comment:
    types: [created]

jobs:
  review:
    # Run on PR events as before, or when a new PR comment contains "@claude /review"
    if: >-
      (
        github.event_name == 'pull_request' &&
        (
          github.event.action == 'ready_for_review' ||
          (
            github.event.action == 'opened' &&
            github.event.pull_request.draft == false
          )
        )
      ) ||
      (
        github.event_name == 'issue_comment' &&
        github.event.issue.pull_request != null &&
        contains(github.event.comment.body, '@claude /review') &&
        (
          github.event.comment.author_association == 'OWNER' ||
          github.event.comment.author_association == 'MEMBER' ||
          github.event.comment.author_association == 'COLLABORATOR'
        )
      )
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
      id-token: write
    steps:
      - name: Check GitHub App private key
        id: check_app_private_key
        # Only runs when the workflow has access to secrets (non-fork contexts).
        if: ${{ github.event_name != 'pull_request' || github.event.pull_request.head.repo.fork == false }}
        run: |
          set -euo pipefail
          if [ -n "${APP_PRIVATE_KEY}" ]; then
            echo "has_private_key=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_private_key=false" >> "$GITHUB_OUTPUT"
          fi
        env:
          APP_PRIVATE_KEY: ${{ secrets.APP_PRIVATE_KEY }}

      - name: Mint identity token
        id: mint_identity_token
        # Run when an App is configured AND we're not in a forked PR context
        # (secrets are unavailable for forked pull_request events).
        if: ${{ vars.APP_ID && steps.check_app_private_key.outputs.has_private_key == 'true' }}
        uses: actions/create-github-app-token@a8d616148505b5069dccd32f177bb87d7f39123b
        with:
          app-id: ${{ vars.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}
          permission-contents: read
          permission-issues: write
          permission-pull-requests: write

      - name: Resolve PR details
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            let prNumber = '';
            if (context.payload.pull_request) {
              prNumber = String(context.payload.pull_request.number);
            } else if (context.eventName === 'issue_comment' && context.payload.issue.pull_request) {
              prNumber = String(context.payload.issue.number);
            }

            let headBranch = '';
            let headSha = '';
            let mergeRef = context.ref;
            let headRef = context.ref;
            let checkoutRef = context.ref;
            let headRepoFullName = '';
            let headRepoCloneUrl = '';

            if (prNumber) {
              const { data: pr } = await github.rest.pulls.get({
                owner,
                repo,
                pull_number: Number(prNumber),
              });

              headBranch = pr.head?.ref || '';
              headSha = pr.head?.sha || '';
              mergeRef = `refs/pull/${prNumber}/merge`;
              headRef = `refs/pull/${prNumber}/head`;
              checkoutRef = headRef;
              headRepoFullName = pr.head?.repo?.full_name || '';
              headRepoCloneUrl = pr.head?.repo?.clone_url || '';

              try {
                await github.rest.git.getRef({
                  owner,
                  repo,
                  ref: `pull/${prNumber}/merge`,
                });
                checkoutRef = mergeRef;
              } catch (error) {
                core.info(`Merge ref not available for PR #${prNumber}; using head ref.`);
              }
            }

            core.setOutput('checkout_ref', checkoutRef);
            core.setOutput('merge_ref', mergeRef);
            core.setOutput('head_ref', headRef);
            core.setOutput('head_branch', headBranch);
            core.setOutput('head_sha', headSha);
            core.setOutput('head_repo_full_name', headRepoFullName || '');
            core.setOutput('head_repo_clone_url', headRepoCloneUrl || '');
            core.setOutput('number', prNumber);

      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          ref: ${{ steps.pr.outputs.checkout_ref }}
          token: ${{ steps.mint_identity_token.outputs.token || secrets.GITHUB_TOKEN || github.token }}
          fetch-depth: 0

      - name: Prepare PR workspace
        if: steps.pr.outputs.number
        env:
          PR_NUMBER: ${{ steps.pr.outputs.number }}
          HEAD_REF: ${{ steps.pr.outputs.head_ref }}
          HEAD_BRANCH: ${{ steps.pr.outputs.head_branch }}
        run: |
          set -e
          if [ -n "${HEAD_REF}" ]; then
            TARGET="refs/remotes/origin/${HEAD_BRANCH:-pr-${PR_NUMBER}-head}"
            git fetch origin "${HEAD_REF}:${TARGET}" || true
          fi

      - name: Point origin at PR fork
        if: >-
          steps.pr.outputs.head_repo_clone_url &&
          steps.pr.outputs.head_repo_full_name &&
          steps.pr.outputs.head_repo_full_name != github.repository
        env:
          HEAD_REPO_CLONE_URL: ${{ steps.pr.outputs.head_repo_clone_url }}
          HEAD_BRANCH: ${{ steps.pr.outputs.head_branch }}
          PR_NUMBER: ${{ steps.pr.outputs.number }}
        run: |
          set -euo pipefail
          git remote rename origin upstream
          git remote add origin "${HEAD_REPO_CLONE_URL}"
          if [ -n "${HEAD_BRANCH}" ]; then
            git fetch origin "${HEAD_BRANCH}:${HEAD_BRANCH}" --depth=20 || true
          fi

      - uses: anthropics/claude-code-action@v1
        env:
          PR_NUMBER: ${{ steps.pr.outputs.number || github.event.pull_request.number || github.event.issue.number }}
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          track_progress: true # ✨ Enables tracking comments
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ env.PR_NUMBER }}
            Review only documentation-related changes.
            Use CONTRIBUTING.md at the repo root as the single source of truth for what to check and how to comment. Do not restate rules; apply them.
            Provide inline comments for specific issues and one summary comment referencing the PR Checklist in CONTRIBUTING.md. Ignore date related guideline.
            Do not mention things that are correct. Do not praise or restate compliant items.
            Check technical accuracy of documentation changes. When in doubt, verify facts using web lookups.

            Technical accuracy and sources:
            - Prefer official OpenTelemetry sources in this strict order when verifying claims:
              1) https://opentelemetry.io/docs/* (official docs)
              2) https://github.com/open-telemetry/* (official repos, READMEs, examples)
              3) Other reputable sources only if the above do not cover it
            - When you verify or correct content based on a source, include a short inline citation with the URL at the end of the comment or suggestion, e.g. "Source: https://opentelemetry.io/docs/...". Do not add footnotes—just paste the link.
            - Prioritize accuracy for: configuration keys, receiver/exporter names, environment variables, CLI flags, API names, semantic conventions, version compatibility and deprecations.
            - If sources conflict, prefer the most recent official OpenTelemetry documentation/repository over blogs or third-party articles.

            Web lookup usage:
            - Prefer the Claude web search tool to discover sources. Use targeted queries (e.g., "site:opentelemetry.io <topic>") to find canonical references.
            - You may fetch pages via curl to inspect authoritative docs when needed. Keep requests minimal and targeted to the specific topic.
            - Do not paste large fetched content into comments; instead summarize and cite the canonical link.

            Labeling:
            - If this PR adds a NEW documentation file (not just modifies an existing one) that explains how to send data to SigNoz Cloud (e.g., a new instrumentation, a new collector receiver, or a new log collection method), you MUST add the label "add-to-onboarding" to the PR.
            - To add the label, execute the command: gh issue edit ${{ env.PR_NUMBER }} --add-label "add-to-onboarding"

          claude_args: |
            --allowedTools "WebSearch,WebFetch,mcp__github_inline_comment__create_inline_comment,Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*),Bash(gh issue edit:*),Bash(gh api:*),Bash(cat:*),Bash(curl:*),Bash(grep:*),Bash(head:*),Bash(tail:*)"
